<!doctype html>
<html lang="en-us">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <title>Miki 3</title>
    </head>
    <body>

    <div style="width: 100%; display: table; z-index: 100">
        <div style="display: table-row">
            <div style="width: 80%; display: table-cell;">
                <input type="text" id="currPath" style="width: 90%;">
            </div>
            <div style="display:table-cell;">
                <button type="button" id="btnAdd">+</button>
                <button type="button" id="btnDel">-</button>
                <button type="button" id="btnEdit">.</button>
            </div>
        </div>
    </div>
     <div style="width: 100%; display: table; z-index: 100">
        <div style="display: table-row">
            <div style="width: 15%; display: table-cell;">
                <ul id="contentsList" style="list-style-type:none">
                    <li>Some list item</li>
                </ul>
            </div>
            <div style="display: table-cell;">
                <div id="contentPage">
                </div>
            </div>
        </div>
    </div>

    <div id="editDiv" style="z-index: 1000; position: fixed; top: 40px; left: 40px; bottom: 40px; right: 40px; display: none;">
        <input type="hidden" id="dialogType" />
        <input id="editContainerPath" type="text" style="width: 90%;"/>
        <br />
        <textarea id="editContent" placeholder="Loading ..." rows="20" cols="80">
        </textarea>
        <br />
        <button type="button" id="closeEdit">Cancel</button>
        <button type="button" id="commitEdit">Commit</button>
    </div>

    </body>
    <script type='text/javascript'>
        var displayedPath = document.getElementById('currPath');

        var contentsList = document.getElementById("contentsList");
        contentsList.addEventListener('click', function(event){
            var thisPath = event.target.getAttribute('data-item-path');
            if (event.target.getAttribute('data-item-type') == 'd')
            {
                displayedPath.value = thisPath;
                JSAccessorInst.get(thisPath, Module.ResourceType.Folder);
            }
            else
            {
                JSAccessorInst.get(thisPath, Module.ResourceType.Page);
            }
        });

        var contentPage = document.getElementById('contentPage');
        var activePath;
        document.getElementById('contentsList').addEventListener('click', function(event) {
            activePath = event.target.dataset.itemPath;
        });

        // Edit form
        function showEditDiv() {
            var parentDiv = document.getElementById('editDiv');
            parentDiv.style.zIndex = "1";
            parentDiv.style.display = 'block';

            document.getElementById('editContainerPath').value = activePath;
            // setting contents
            var editContent = document.getElementById('editContent');
            var editType    = document.getElementById('dialogType').value;
            switch (editType)
            {
                case 'edit':
                case 'add':
                    editContent.style.display = 'block';
                    document.getElementById('commitEdit').innerText = "Commit";
                    break;
                case 'rm':
                    editContent.style.display = 'none';
                    document.getElementById('commitEdit').innerText = "Remove";
                    break;
            }

            // dim others
            displayedPath.style.opacity = '.2';
            contentsList.style.opacity = '.2';
            contentPage.style.opacity = '.2';
        };
        
        function hideEditDiv() {
            var parentDiv = document.getElementById('editDiv');
            parentDiv.style.zIndex = "1000";
            parentDiv.style.display = 'none';
            // setting contents
            var editContent = document.getElementById('editContent');
            editContent.value = "";
            var containerPath = document.getElementById('editContainerPath');
            containerPath.value = "";
            // undim others
            displayedPath.style.opacity = '1';
            contentsList.style.opacity = '1';
            contentPage.style.opacity = '1';
        };

        document.getElementById('closeEdit').addEventListener('click', function(event) {
            hideEditDiv();
        });

        document.getElementById('commitEdit').addEventListener('click', function(event) {
            url = document.getElementById('editContainerPath').value;
            type = document.getElementById('dialogType').value;

            url = "/muki/" + type + "/" + url;

            var xhr = new XMLHttpRequest();
            xhr.open("POST", url, true);
            xhr.setRequestHeader('Content-Type', 'application/text');
            xhr.send(document.getElementById('editContent').value);

            console.log('Calling: ' + url);

            hideEditDiv();
        });

        document.getElementById('btnAdd').addEventListener('click', function(event) {
            document.getElementById('dialogType').value = "add";
            showEditDiv();
        });

        document.getElementById('btnEdit').addEventListener('click', function(event) {
            var path = activePath;
            path += '-raw';
            JSAccessorInst.get(path, Module.ResourceType.Edit);

            document.getElementById('dialogType').value = "edit";
            showEditDiv();
        });

        document.getElementById('btnDel').addEventListener('click', function(event) {
            document.getElementById('dialogType').value = "rm";
            showEditDiv();
        });

        var rootPath = "/pages/";

        var JSAccessorInst = {};
        var Module = {
            'print': function(text) { console.log('STDOUT: ' + text); },
            'printErr': function(text) { console.log('STDERR: ' + text); },
            onRuntimeInitialized: function() {
                var JSAccessor = Module.Accessor.extend("Accessor", {
                    onFolder: function(payload) {
                        contentsList.innerHTML = '';
                        // Insert .. => previous path, if not root
                        if ((displayedPath.value + "/") != rootPath)
                        {
                            var lastFwdSlash = displayedPath.value.lastIndexOf("/");
                            var backItem = document.createElement("li");
                            backItem.textContent = "[ .. ]";
                            backItem.value = 0;
                            backItem.setAttribute('data-item-type', 'd');
                            backItem.setAttribute('data-item-path', displayedPath.value.substr(0, lastFwdSlash));
                            contentsList.appendChild(backItem);
                        }
                        for (var i=0; i<payload.size(); i++)
                        {
                            var mikiEl = payload.get(i);
                            var listItem = document.createElement("li");
                            listItem.textContent = (mikiEl.type == Module.ResourceType.Folder ? '[ ' + mikiEl.name + ' ]' : mikiEl.name);
                            listItem.value = i;
                            listItem.setAttribute(
                                'data-item-type',
                                (mikiEl.type == Module.ResourceType.Folder ? 'd' : 'p')
                            );
                            listItem.setAttribute('data-item-path', mikiEl.path);
                            contentsList.appendChild(listItem);
                        }
                    },
                    onPage: function(payload) {
                        contentPage.innerHTML = payload;
                    },
                    onEdit: function(payload) {
                        document.getElementById('editContent').value = payload;        
                    },
                    onError: function(url, status) {
                        var errorStr = "ERROR: '";
                        errorStr += url;
                        errorStr += "' (";
                        errorStr += status;
                        errorStr += ")";

                        alert(errorStr);
                    },
                });

                JSAccessorInst = new JSAccessor;
                displayedPath.value = rootPath;

                JSAccessorInst.get(rootPath, Module.ResourceType.Folder);

            }
        };
    </script>
    <script async type="text/javascript" src="miki.js"></script>
</html>


